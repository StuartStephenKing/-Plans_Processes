#region Prolog

vNow = TIMST (NOW(), '\Y-\m-\d \h:\i:\s' );
vUser = TM1User();

vPlanStateCube = pPrefix | '_' | pPlan | '_State';
vPlanTaskDimension = pPrefix | '_' | pPlan | '_Tasks';
vPlanControlCube = pPrefix;

vPlanApprovalDimension = pPrefix | '_' | pPlan | '_Approval';
vPlanApprovalHierarchy = vPlanApprovalDimension;
vPlanApprovalSubset = 'Default';

# List of node states
# 0 - Available
# 1 - In Progress
# 2 - Reserved 
# 3 - Pending 
# 4 - Completed 

CellPutS ( '0', vPlanStateCube, pNode, pTask, 'State' ); 
CellPutS ( '', vPlanStateCube, pNode, pTask, 'Owner' ); 
CellPutS ( '', vPlanStateCube, pNode, pTask, 'WorkspaceOwner' ); 
CellPutS ( '', vPlanStateCube, pNode, pTask, 'TakeOwnershipNode' ); 
CellPutS ( 'User ' | vUser | ' reset node', vPlanStateCube, pNode, pTask, 'Last action' ); 
CellPutS ( vNow, vPlanStateCube, pNode, pTask, 'Last Update' );          

#  Updated the descendants of the node where the state is changing 
vElementChildCount = ElementComponentCount ( vPlanApprovalDimension, vPlanApprovalHierarchy, pNode );
IF ( vElementChildCount > 0);
    vElementIndex = 1;        
    vNodeChild = ElementName ( vPlanApprovalDimension, vPlanApprovalHierarchy, vElementIndex );
    WHILE ( vNodeChild @<> '' );
        IF ( ElementIsAncestor ( vPlanApprovalDimension, vPlanApprovalHierarchy, pNode, vNodeChild )  = 1 );
            CellPutS ( '0', vPlanStateCube, vNodeChild, pTask, 'State' ); 
            CellPutS ( '', vPlanStateCube, vNodeChild, pTask, 'Owner' ); 
            CellPutS ( '', vPlanStateCube, vNodeChild, pTask, 'WorkspaceOwner' ); 
            CellPutS ( '', vPlanStateCube, vNodeChild, pTask, 'TakeOwnershipNode' );
            CellPutS ( 'User ' | vUser | ' reset node', vPlanStateCube, vNodeChild, pTask, 'Last action' ); 
            CellPutS ( vNow, vPlanStateCube, vNodeChild, pTask, 'Last Update' );          

        ENDIF;
        vElementIndex = vElementIndex + 1;       
        vNodeChild = ElementName( vPlanApprovalDimension, vPlanApprovalHierarchy, vElementIndex );
    END;
ENDIF;

#  Update the ancestors of the node where the state is changing
vElementParentCount = ElementParentCount ( vPlanApprovalDimension, vPlanApprovalHierarchy, pNode );
IF ( vElementParentCount = 1);
    vParentNode = ElementParent ( vPlanApprovalDimension, vPlanApprovalHierarchy, pNode, 1 );
    ExecuteProcess ( '}Plans_SetNodeParentState',
                    'pPlan', pPlan,
                    'pTask', pTask,
                    'pNode', vParentNode,
                    'pState', '0',
                    'pPrefix', pPrefix );
ENDIF;


#endregion